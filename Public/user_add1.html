<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ADD USER</title>
    <style>
        /* --- ERP Styles --- */
        :root {
            --primary-color: #2980b9;
            --success-color: #27ae60; /* Green for Save */
            --danger-color: #8B0000;  /* Dark Red for Cancel & Mandatory */
            --secondary-color: #7f8c8d; /* Gray for Close & Icons */
            --sidebar-bg: #2c3e50;
            --navbar-bg: #ffffff;
            --main-bg: #ecf0f1;
            --card-bg: #ffffff;
            --text-color: #34495e;
            --light-text-color: #ffffff;
            --border-color: #e0e0e0;
            --input-bg-color: #fdfdfd;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --navbar-height: 50px;  
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; background-color: var(--main-bg); color: var(--text-color); }
        .top-navbar { height: var(--navbar-height); width: 100%; background-color: var(--primary-color); box-shadow: var(--shadow); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; position: fixed; top: 0; left: 0; z-index: 1001; }
        .navbar-left { display: flex; align-items: center; gap: 15px; }
        .hamburger-menu { font-size: 24px; cursor: pointer; background: none; border: none; color: #ffffff; padding: 8px; border-radius: 6px; transition: background-color 0.2s ease-in-out; }
        .hamburger-menu:hover { background-color: rgba(255, 255, 255, 0.15); }
        .navbar-brand { font-size: 1.4rem; font-weight: 600; color: var(--light-text-color); padding: 8px 12px; border-radius: 6px; transition: background-color 0.2s ease-in-out; }
        .navbar-brand:hover { background-color: rgba(255, 255, 255, 0.15); }
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .user-profile span { font-weight: 500; display: none; color: var(--light-text-color); }
        @media (min-width: 576px) { .user-profile span { display: block; } }
        .user-profile img { width: 20px; height: 20px; border-radius: 50%; object-fit: cover; }
        .sidebar { width: 260px; background-color: var(--sidebar-bg); color: var(--light-text-color); position: fixed; top: var(--navbar-height); left: 0; height: calc(100vh - var(--navbar-height)); z-index: 1000; transform: translateX(0); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .sidebar.closed { transform: translateX(-100%); }
        .module-selector { padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; gap: 10px; }
        .module-icon { width: 40px; height: 40px; flex-shrink: 0; background-color: #ffffff; border-radius: 50%; }
        .module-wrapper { position: relative; flex-grow: 1; display: flex; flex-direction: column; }
        .current-module { background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; padding: 10px 15px; width: 100%; display: flex; align-items: center; justify-content: space-between; cursor: pointer; color: var(--light-text-color); font-size: 1rem; font-weight: 500; }
        .current-module svg { width: 16px; height: 16px; transition: transform 0.2s ease-in-out; }
        .current-module.open svg { transform: rotate(180deg); }
        .module-dropdown { display: none; position: absolute; width: 100%; top: calc(100% + 5px); left: 0; background-color: #34495e; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1010; max-height: 300px; overflow-y: auto; }
        .module-dropdown.show { display: block; }
        .module-dropdown a { display: block; padding: 12px 15px; color: var(--light-text-color); text-decoration: none; font-size: 0.9rem; }
        .module-dropdown a:hover { background-color: var(--primary-color); }
        .sidebar-nav { flex-grow: 1; overflow-y: auto; }
        .sidebar-nav ul { list-style-type: none; padding-left: 0; }
        .sidebar-nav li a { display: flex; align-items: center; padding: 14px 20px; color: var(--light-text-color); text-decoration: none; font-size: 0.95rem; transition: background-color 0.2s, padding-left 0.2s; }
        .sidebar-nav .has-submenu > a { justify-content: space-between; }
        .sidebar-nav li a:hover { background-color: rgba(255, 255, 255, 0.1); }
        .sidebar-nav li.active > a { background-color: var(--primary-color); }
        .sidebar-nav svg { width: 20px; height: 20px; margin-right: 15px; flex-shrink: 0; }
        .submenu-arrow { width: 16px; height: 16px; transition: transform 0.3s ease; margin-right: 0; }
        .submenu { list-style-type: none; background-color: rgba(0,0,0,0.2); max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; padding-left: 0; }
        .submenu > li > a { padding-left: 35px !important; }
        .submenu .submenu > li > a { padding-left: 55px !important; font-size: 0.9rem !important; }
        .has-submenu.open > .submenu { max-height: 1000px; }
        .has-submenu.open > a .submenu-arrow { transform: rotate(90deg); }
        
        .main-content { margin-top: var(--navbar-height); margin-left: 260px; padding: 0 25px 20px 25px; width: calc(100% - 260px); transition: margin-left 0.3s ease-in-out, width 0.3s ease-in-out; }
        .main-content.full-width { margin-left: 0; width: 100%; }
        .menu-item-content { display: flex; align-items: center; }

        /* --- Form Specific Styles --- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            margin-top: 10px;
        }
        .page-header h1 { font-size: 18px; font-weight: 700; color: var(--text-color); }
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color);}
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; position: relative; }
        .form-group.full-span { grid-column: 1 / -1; }
        .form-group label { margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #555; }
        
        .label-required { color: var(--danger-color) !important; }
        
        .form-control, .form-select {
            width: 100%;
            padding: 12px 15px;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            background-color: var(--input-bg-color);
        }
        
        .form-control:hover, .form-select:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.2);
            background-color: #fff;
        }

        .radio-group { display: flex; gap: 25px; align-items: center; margin-top: 10px; }
        .radio-group label { display: flex; align-items: center; cursor: pointer; font-weight: 500; font-size: 1rem; position: relative; user-select: none; }
        .radio-group input[type="radio"] { opacity: 0; position: absolute; width: 0; height: 0; }
        .radio-custom {
            height: 18px;
            width: 18px;
            background-color: var(--input-bg-color);
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: inline-block;
            margin-right: 10px;
            transition: all 0.2s ease;
            position: relative;
        }
        .radio-custom::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: var(--primary-color);
            transition: transform 0.2s ease;
        }
        .radio-group input[type="radio"]:checked + .radio-custom { border-color: var(--primary-color); }
        .radio-group input[type="radio"]:checked + .radio-custom::after { transform: translate(-50%, -50%) scale(1); }
        .radio-group label:hover .radio-custom { border-color: var(--primary-color); }
        
        .searchable-select-container { position: relative; width: 100%; }
        .searchable-select-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            width: 100%;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }
        .searchable-select-dropdown.show { display: block; }
        .searchable-select-option { padding: 12px 15px; cursor: pointer; font-size: 1rem; }
        .searchable-select-option:hover, .searchable-select-option.highlighted {
            background-color: var(--primary-color);
            color: var(--light-text-color);
        }
        .searchable-select-option.no-results { cursor: default; color: #888; }
        .searchable-select-option.no-results:hover { background-color: transparent; color: #888; }

        .form-actions { display: flex; justify-content: center; gap: 15px; margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .btn { padding: 10px 22px; font-size: 1rem; font-weight: 600; font-family: sans-serif; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease-in-out; text-decoration: none; text-align: center; color: var(--light-text-color); display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .btn:active { transform: translateY(0); box-shadow: none; }
        .btn svg { width: 20px; height: 20px; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #2ecc71; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-color); }
        .btn-secondary:hover { background-color: #95a5a6; }
        
        .header-action-link { 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 12px; 
            text-decoration: none; 
            color: var(--primary-color); 
            border-radius: 6px; 
            transition: background-color 0.2s ease-in-out; 
            font-size: 18px;
            font-weight: 700;
        }
        .header-action-link:hover { background-color: rgba(41, 128, 185, 0.1); }
        .header-action-link svg { width: 22px; height: 22px; stroke-width: 1.5; }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          appearance: textfield;
          -moz-appearance: textfield;
        }

        /* --- User Roles Info Styles --- */
        .user-roles-info {
            margin-top: 25px;
        }
        .user-roles-info h2 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .user-roles-info .role {
            margin-bottom: 15px;
        }
        .user-roles-info .role:last-child {
            margin-bottom: 0;
        }
        .user-roles-info h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        .user-roles-info p {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.5;
        }

    </style>
</head>
<body>
    <header class="top-navbar">
        <div class="navbar-left">
            <button class="hamburger-menu" id="hamburger-menu">☰</button>
            <div class="navbar-brand">ARV Technical Services</div>
        </div>
        <div class="user-profile">
            <img src="https://i.pravatar.cc/150?u=a042581f4e29026704d" alt="User Avatar">
            <span>Anshul Sharma</span>
        </div>
    </header>

    <aside class="sidebar closed" id="sidebar">
        <div class="module-selector">
            <img src="https://newdemo.nwayerp.org/mis_css/img/mis_icon/account_1.png" alt="Module Icon" class="module-icon">
            <div class="module-wrapper">
                <button class="current-module" id="module-toggle">
                    <span id="current-module-name">Loading...</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                <div class="module-dropdown" id="module-dropdown"></div>
            </div>
        </div>
        <nav class="sidebar-nav">
             <ul id="sidebar-menu-list"></ul>
        </nav>
    </aside>

    <main class="main-content full-width" id="main-content">
        <div class="page-header">
            <h1>Admin > Master > User > Add</h1>
            <a href="user_list.html" class="header-action-link">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                </svg>
                List
            </a>
        </div>

        <div class="card">
            <form id="addUserForm">
                <div class="form-grid">
                    <div class="form-group full-span">
                        <label>User Category</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="User_Category" value="I" required checked>
                                <span class="radio-custom"></span>
                                Internal
                            </label>
                            <label>
                                <input type="radio" name="User_Category" value="E" required>
                                <span class="radio-custom"></span>
                                External
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="employee-group">
                        <label for="employee-search-input" class="label-required">Employee Name *</label>
                        <div class="searchable-select-container">
                             <input type="text" id="employee-search-input" class="form-control" placeholder="Search and select employee..." autocomplete="off" required>
                             <div id="employee-dropdown" class="searchable-select-dropdown"></div>
                        </div>
                        <select id="User_employeeid" name="User_employeeid" class="form-control form-select" style="display: none;" required>
                            <option value="" disabled selected>Select an employee</option>
                            <option value="101">Ravi Kumar (DEV-01)</option>
                            <option value="102">Sunita Singh (MKT-05)</option>
                            <option value="103">Amit Patel (HR-02)</option>
                        </select>
                    </div>
                    <div class="form-group">

                        <label for="UserName" class="label-required">User Name *</label>
                        <input type="text" id="UserName" name="UserName" class="form-control" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group">
                        <label for="User_login" class="label-required">User Login *</label>
                        <input type="text" id="User_login" name="User_login" class="form-control" placeholder="Create a unique login ID" required>
                    </div>
                    <div class="form-group">
                        <label for="User_Mobile">Mobile No.</label>
                        <input type="number" id="User_Mobile" name="User_Mobile" class="form-control" placeholder="Enter 10-digit mobile number">
                    </div>
                    <div class="form-group">
                        <label for="User_emailid">Email ID</label>
                        <input type="email" id="User_emailid" name="User_emailid" class="form-control" placeholder="e.g., user@example.com">
                    </div>
                    <div class="form-group">
                        <label for="User_Password" class="label-required">Password *</label>
                        <input type="password" id="User_Password" name="User_Password" class="form-control" placeholder="Enter a strong password" required>
                    </div>
                    <div class="form-group">
                        <label for="UserType" class="label-required">User Type *</label>
                        <select id="UserType" name="UserType" class="form-control form-select" required>
                            <option value="Super Admin">Super</option>
                            <option value="Admin">Admin</option>
                            <option value="User" selected>User</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" id="clearBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" /></svg>
                        Clear
                    </button>
                    <button type="submit" class="btn btn-success">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                        Save
                    </button>
                    <a href="index.html" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        Close
                    </a>
                </div>
            </form>
        </div>

        <div class="card user-roles-info">
            <h2>User Type Descriptions</h2>
            <div class="role">
                <h3>1. SUPER</h3>
                <p>Person who have rights of complete ERP software from A to Z. (All Module / All Form)</p>
            </div>
            <div class="role">
                <h3>2. ADMIN</h3>
                <p>If user type is admin for any particular module, he /she have complete rights on that particular module only . (Assigned Module / All Form)</p>
            </div>
            <div class="role">
                <h3>3. USER</h3>
                <p>In this type, user can access assign module and its respective functionality. (Assigned Module / Assigned Form)</p>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Login Check ---
        // Checks if a login token exists in localStorage. If not, redirects to login.html.
        // Replace 'authToken' with the actual key your application uses to store the login token.
        const authToken = localStorage.getItem('authToken'); 
        if (!authToken) {
            // alert('You must be logged in to access this page. Redirecting...');
            window.location.href = 'login.html';
            return; // Stop the rest of the script from executing
        }

        // --- Sidebar logic ---
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const hamburger = document.getElementById('hamburger-menu');
        const moduleToggle = document.getElementById('module-toggle');
        const moduleDropdown = document.getElementById('module-dropdown');
        const currentModuleName = document.getElementById('current-module-name');
        const sidebarMenuList = document.getElementById('sidebar-menu-list');
        const icons = {
            Dashboard: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>`,
            Master: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.906 59.906 0 0112 3.493a59.903 59.903 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0l-.07.042m15.482 0l.07.042m-15.552 0l-2.298-.447a1.125 1.125 0 01.402-2.173l2.128.414a1.125 1.125 0 001.103-.89l.17-1.005a1.125 1.125 0 011.123-.88h1.18c.613 0 1.123.495 1.123 1.109l.17 1.005a1.125 1.125 0 001.103.89l2.128-.415a1.125 1.125 0 01.402 2.172l-2.298.447m-15.552 0l15.552 0" /></svg>`,
            Transaction: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>`,
            Reports: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z" /></svg>`,
            Setting: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 01 1.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.447.368.622.992.404 1.522l-1.296-2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.075.124a6.57 6.57 0 01-.22.127c-.332.183-.582.495-.645.87l-.213 1.281c-.09.543-.56.94-1.11.94h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01 .26-1.431l1.003-.827c.293-.24.438.613.438.995s-.145-.755-.438-.995l-1.003-.827a1.125 1.125 0 01-.404-1.522l1.296-2.247a1.125 1.125 0 01 1.37-.49l1.217.456c.355.133.75.072 1.075-.124.073-.044.146-.087.22-.127.332-.183.582.495.645.87l.213-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>`
        };
        const submenuArrowIcon = `<svg class="submenu-arrow" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>`;
    
        hamburger.addEventListener('click', () => { sidebar.classList.toggle('closed'); mainContent.classList.toggle('full-width'); });
        moduleToggle.addEventListener('click', (e) => { e.stopPropagation(); moduleDropdown.classList.toggle('show'); moduleToggle.classList.toggle('open'); });
        window.addEventListener('click', (e) => { if (!moduleToggle.parentElement.contains(e.target)) { moduleDropdown.classList.remove('show'); moduleToggle.classList.remove('open'); } });
        
        async function populateModules() { try { const response = await fetch(`${BASE_URL}/api/modules`); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const modules = await response.json(); moduleDropdown.innerHTML = ''; modules.forEach(module => { const link = document.createElement('a'); link.href = '#'; link.textContent = module.MODULE_NAME; link.setAttribute('data-module-id', module.MODULE_KID); link.addEventListener('click', handleModuleSelection); moduleDropdown.appendChild(link); }); if (modules.length > 0) { currentModuleName.textContent = modules[0].MODULE_NAME; loadMenuForModule(modules[0].MODULE_KID); } else { currentModuleName.textContent = "No Modules"; sidebarMenuList.innerHTML = '<li><a>No menu items found.</a></li>'; } } catch (error) { console.error("Error fetching modules:", error); currentModuleName.textContent = "Error"; sidebarMenuList.innerHTML = '<li><a>Error loading modules. Check console.</a></li>'; } }
        function handleModuleSelection(e) { e.preventDefault(); const moduleId = this.getAttribute('data-module-id'); const moduleName = this.textContent; currentModuleName.textContent = moduleName; moduleDropdown.classList.remove('show'); moduleToggle.classList.remove('open'); loadMenuForModule(moduleId); }
        async function loadMenuForModule(moduleId) { sidebarMenuList.innerHTML = '<li><a>Loading...</a></li>'; try { const response = await fetch(`${BASE_URL}/api/menus?moduleId=${moduleId}`); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const data = await response.json(); const menusWithSubmenus = new Map(); data.forEach(item => { if (!menusWithSubmenus.has(item.MENU_KID)) { menusWithSubmenus.set(item.MENU_KID, { id: item.MENU_KID, name: item.MENU_NAME, type: item.MENU_TYPE, submenus: [] }); } if (item.SUBMENU_KID) { menusWithSubmenus.get(item.MENU_KID).submenus.push({ id: item.SUBMENU_KID, name: item.SUBMENU_NAME, redirectPage: item.SUBMENU_REDIRECTPAGE }); } }); const groupedByType = new Map(); menusWithSubmenus.forEach(menu => { if (!groupedByType.has(menu.type)) { groupedByType.set(menu.type, []); } groupedByType.get(menu.type).push(menu); }); renderSidebarMenu(groupedByType); } catch (error) { console.error("Error fetching menu data:", error); sidebarMenuList.innerHTML = '<li><a>Error loading menu. Check console.</a></li>'; } }
        function renderSidebarMenu(groupedData) { sidebarMenuList.innerHTML = ''; if (groupedData.size === 0) { sidebarMenuList.innerHTML = '<li><a>No menu items found.</a></li>'; return; } const menuOrder = ['Dashboard', 'Master', 'Transaction', 'Reports', 'Setting']; menuOrder.forEach(menuType => { if (groupedData.has(menuType)) { const menuItems = groupedData.get(menuType); const iconSVG = icons[menuType] || icons['Master']; const categoryLi = document.createElement('li'); categoryLi.classList.add('has-submenu'); categoryLi.innerHTML = `<a href="#"><span class="menu-item-content">${iconSVG}<span>${menuType}</span></span>${submenuArrowIcon}</a>`; const submenuUl = document.createElement('ul'); submenuUl.classList.add('submenu'); menuItems.forEach(item => { const itemLi = document.createElement('li'); if (item.submenus.length > 0) { itemLi.classList.add('has-submenu'); itemLi.innerHTML = `<a href="#"><span>${item.name}</span>${submenuArrowIcon}</a><ul class="submenu">${item.submenus.map(sub => `<li><a href="${sub.redirectPage || '#'}">${sub.name}</a></li>`).join('')}</ul>`; } else { itemLi.innerHTML = `<a href="#"><span>${item.name}</span></a>`; } submenuUl.appendChild(itemLi); }); categoryLi.appendChild(submenuUl); sidebarMenuList.appendChild(categoryLi); } }); initializeAccordion(); }
        function initializeAccordion() { const allToggles = document.querySelectorAll('.sidebar-nav .has-submenu > a'); allToggles.forEach(toggle => { const newToggle = toggle.cloneNode(true); toggle.parentNode.replaceChild(newToggle, toggle); newToggle.addEventListener('click', function(event) { event.preventDefault(); event.stopPropagation(); const clickedLi = this.parentElement; const wasOpen = clickedLi.classList.contains('open'); const parentUl = clickedLi.parentElement; const allMenusInLevel = parentUl.querySelectorAll(':scope > .has-submenu'); allMenusInLevel.forEach(menuLi => { menuLi.classList.remove('open'); }); if (!wasOpen) { clickedLi.classList.add('open'); } }); }); }
    
        populateModules();

        // --- Form Logic ---
        const addUserForm = document.getElementById('addUserForm');
        const userCategoryRadios = document.querySelectorAll('input[name="User_Category"]');
        const employeeGroup = document.getElementById('employee-group');
        const employeeSelect = document.getElementById('User_employeeid');
        const employeeSearchInput = document.getElementById('employee-search-input');
        const clearBtn = document.getElementById('clearBtn');

        function handleCategoryChange() {
            const selectedCategory = document.querySelector('input[name="User_Category"]:checked').value;
            if (selectedCategory === 'I') {
                employeeGroup.style.display = 'flex';
                employeeSelect.required = true;
                employeeSearchInput.required = true;
            } else {
                employeeGroup.style.display = 'none';
                employeeSelect.required = false;
                employeeSearchInput.required = false;
                employeeSelect.value = '';
                employeeSearchInput.value = '';
            }
        }
        userCategoryRadios.forEach(radio => radio.addEventListener('change', handleCategoryChange));
        
        // Initial check on page load
        handleCategoryChange();

        // Searchable Employee Dropdown Logic
        const employeeDropdown = document.getElementById('employee-dropdown');
        const originalOptions = Array.from(employeeSelect.options).filter(opt => opt.value);

        function renderDropdown(optionsToRender) {
            if (optionsToRender.length === 0) {
                employeeDropdown.innerHTML = `<div class="searchable-select-option no-results">No results found</div>`;
            } else {
                employeeDropdown.innerHTML = optionsToRender.map(opt => 
                    `<div class="searchable-select-option" data-value="${opt.value}">${opt.textContent}</div>`
                ).join('');
            }
            employeeDropdown.classList.add('show');
        }

        employeeSearchInput.addEventListener('input', () => {
            const searchTerm = employeeSearchInput.value.toLowerCase();
            const filteredOptions = originalOptions.filter(opt => opt.textContent.toLowerCase().includes(searchTerm));
            renderDropdown(filteredOptions);
            
            if (employeeSelect.value) {
                const selectedOption = originalOptions.find(opt => opt.value === employeeSelect.value);
                if (!selectedOption || selectedOption.textContent !== employeeSearchInput.value) {
                    employeeSelect.value = '';
                }
            }
        });

        employeeSearchInput.addEventListener('focus', () => {
            renderDropdown(originalOptions);
        });
        
        employeeDropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('searchable-select-option') && e.target.dataset.value) {
                const value = e.target.dataset.value;
                const text = e.target.textContent;
                
                employeeSearchInput.value = text;
                employeeSelect.value = value; // This is the important part
                
                employeeDropdown.classList.remove('show');
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!employeeGroup.contains(e.target)) {
                employeeDropdown.classList.remove('show');
            }
        });

        // --- Form Submission Logic ---
        addUserForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(addUserForm);
            
            // Validate mobile number if entered
            const mobileNo = formData.get('User_Mobile');
            if (mobileNo && mobileNo.length !== 10) {
                alert('Mobile Number must be 10 digits.');
                return;
            }
            
            // Map User Type to S, A, U
            const userTypeMap = { 'Super Admin': 'S', 'Admin': 'A', 'User': 'U' };
            
            // Create the payload object based on the specified schema
            const payload = {
                USER_STATUSID: 1, // Default value
                USER_NAME: formData.get('UserName'),
                USER_LOGIN: formData.get('User_login'),
                USER_PASSWORD: formData.get('User_Password'), // The backend should handle hashing
                USER_EMPLOYEEID: formData.get('User_employeeid') || 0,
                USER_MOBILENO: mobileNo || '0',
                USER_EMAILID: formData.get('User_emailid') || '~',
                USER_TYPE: userTypeMap[formData.get('UserType')],
                USER_CATEGORY: formData.get('User_Category')
            };

            console.log('Submitting payload:', payload);

            try {
                // Replace with your actual API endpoint
                const response = await fetch(`${BASE_URL}/api/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Add authorization headers if needed, e.g.,
                        // 'Authorization': 'Bearer YOUR_AUTH_TOKEN'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('User created successfully!');
                    addUserForm.reset();
                    handleCategoryChange(); // Reset UI state
                    // Optionally, redirect to the user list page
                    // window.location.href = 'user_list.html';
                } else {
                    alert(`Error: ${result.message || 'Failed to create user. Please try again.'}`);
                }
            } catch (error) {
                console.error('Form submission error:', error);
                alert('An unexpected error occurred. Please check the console and try again.');
            }
        });

        // --- Clear Button Logic ---
        clearBtn.addEventListener('click', () => {
            addUserForm.reset();
            employeeSearchInput.value = '';
            handleCategoryChange(); // Reset UI to its default state
        });

    });
    </script>
</body>
</html>